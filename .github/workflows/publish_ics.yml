name: Publish ICS (hourly)

on:
  schedule:
    - cron: '0 * * * *'  # hourly UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'   # <- real version

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build ICS into site/
        run: |
          set -e
          echo "📁 CWD: $(pwd)"
          mkdir -p site
          python run_tournament.py
          # Prove it exists at the repo root first
          ls -la
          test -f usopen_schedule.ics || (echo "❌ usopen_schedule.ics not found at repo root" && exit 1)

          # Move to publish dir
          mv usopen_schedule.ics site/
          echo > site/.nojekyll

          # Minimal index for sanity check
          cat > site/index.html <<'EOF'
          <!doctype html>
          <meta charset="utf-8">
          <title>US Open 2025 Calendar</title>
          <h1>US Open 2025 Calendar</h1>
          <p>Subscribe with this URL:</p>
          <pre id="url"></pre>
          <script>
            const base = location.origin + location.pathname.replace(/\/?$/, '/');
            document.getElementById('url').textContent = base + 'usopen_schedule.ics';
          </script>
          <p>Apple Calendar users can also try the same URL with <code>webcal://</code>.</p>
          EOF

          echo "📄 Contents of site/:"
          ls -la site

      - name: Upload site as artifact (debug)
        uses: actions/upload-artifact@v4
        with:
          name: site
          path: site

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: site          # <- publish only this folder
          publish_branch: gh-pages
          force_orphan: true
